(function(h,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue"),require("uuid"),require("@aivue/core"),require("markdown-it")):typeof define=="function"&&define.amd?define(["exports","vue","uuid","@aivue/core","markdown-it"],e):(h=typeof globalThis<"u"?globalThis:h||self,e(h.AiVueChatbot={},h.Vue,h.uuid,h.AiVueCore,h.MarkdownIt))})(this,function(h,e,S,D,X){"use strict";function K(t){let a;if(t.client)a=t.client;else if(t.provider)a=new D.AIClient({provider:t.provider,apiKey:t.apiKey,model:t.model||R(t.provider),baseUrl:t.baseUrl,organizationId:t.organizationId});else throw new Error("Either client or provider must be specified in options");const{initialMessages:r=[],systemPrompt:u="You are a helpful assistant.",streaming:p=!0,persistenceKey:g=null,maxMessages:w=100,demoMode:d=!1,demoResponses:b={},useProxy:M=!1,proxyUrl:T="/api/chat",onError:V=null,onMessageSent:A=null,onResponseReceived:f=null}=t,i=e.ref([]),y=e.ref(!1),_=e.ref(null),$=s=>s.map(B=>({...B,id:B.id||S.v4(),timestamp:B.timestamp||new Date}));e.onMounted(()=>{if(g)try{const s=localStorage.getItem(g);if(s){i.value=$(JSON.parse(s));return}}catch(s){console.error("Error loading chat history:",s)}i.value=$(r)});const o=()=>{if(g)try{localStorage.setItem(g,JSON.stringify(i.value))}catch(s){console.error("Error saving chat history:",s)}};return e.watch(i,()=>{o()},{deep:!0}),{messages:i,isLoading:y,error:_,sendMessage:async s=>{var F,Y,G,Q;if(!s.trim())return;_.value=null;const B={role:"user",content:s,id:S.v4(),timestamp:new Date};i.value.push(B),A&&A(B),y.value=!0;try{const N=[{role:"system",content:u},...i.value.filter(m=>m.role==="user"||m.role==="assistant").map(({role:m,content:k})=>({role:m,content:k}))];if(d){let m="I'm a demo AI assistant. This is a simulated response.";const k=B.content.toLowerCase();for(const[n,l]of Object.entries(b))if(k.includes(n.toLowerCase())){m=l;break}if(p){const n={role:"assistant",content:"",id:S.v4(),timestamp:new Date};i.value.push(n);let l="";(async()=>{for(const O of m)await new Promise(P=>setTimeout(P,20)),l+=O,n.content=l;y.value=!1,f&&f(n),g&&o()})();return}else{const n={role:"assistant",content:m,id:S.v4(),timestamp:new Date};i.value.push(n),y.value=!1,f&&f(n),g&&o();return}}if(p){let m="";const k={role:"assistant",content:"",id:S.v4(),timestamp:new Date};i.value.push(k);const n={onStart:()=>{console.log("Stream started")},onToken:l=>{m+=l;const C=i.value[i.value.length-1];C&&C.role==="assistant"&&(C.content=m)},onComplete:l=>{if(y.value=!1,console.log("Stream completed"),f){const C=i.value[i.value.length-1];C&&C.role==="assistant"&&f(C)}g&&o()},onError:l=>{console.error("Stream error:",l),_.value=l,y.value=!1,V&&V(l)}};if(M)try{const l=await fetch(T,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:N,model:t.model,stream:!0})});if(!l.ok)throw new Error(`Proxy request failed with status ${l.status}`);if(l.body){const C=l.body.getReader(),O=new TextDecoder;for((F=n.onStart)==null||F.call(n);;){const{done:P,value:qe}=await C.read();if(P)break;const Le=O.decode(qe,{stream:!0});(Y=n.onToken)==null||Y.call(n,Le)}(G=n.onComplete)==null||G.call(n,m)}}catch(l){(Q=n.onError)==null||Q.call(n,l)}else await a.chatStream(N,n)}else{let m;if(M)try{const n=await fetch(T,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:N,model:t.model,stream:!1})});if(!n.ok)throw new Error(`Proxy request failed with status ${n.status}`);const l=await n.json();m=l.content||l.message||l.response||""}catch(n){throw new Error(`Proxy request failed: ${n.message}`)}else m=await a.chat(N);const k={role:"assistant",content:m,id:S.v4(),timestamp:new Date};i.value.push(k),f&&f(k),y.value=!1}if(i.value.length>w){const m=i.value.filter(n=>n.role==="system"),k=i.value.slice(-w);i.value=[...m,...k]}}catch(N){_.value=new Error(`Failed to send message: ${N.message}`),y.value=!1,V&&V(_.value)}},clearMessages:()=>{i.value=[],_.value=null},setMessages:s=>{i.value=$(s)},addMessage:s=>{i.value.push({...s,id:s.id||S.v4(),timestamp:s.timestamp||new Date})},resetError:()=>{_.value=null},updateConfig:s=>{(s.provider||s.apiKey||s.model||s.baseUrl||s.organizationId)&&(a=new D.AIClient({provider:s.provider||t.provider,apiKey:s.apiKey||t.apiKey,model:s.model||t.model||R(s.provider||t.provider),baseUrl:s.baseUrl||t.baseUrl,organizationId:s.organizationId||t.organizationId})),Object.assign(t,s)}}}function R(t){switch(t){case"openai":return"gpt-3.5-turbo";case"claude":return"claude-3-sonnet-20240229";case"gemini":return"gemini-pro";case"huggingface":return"mistralai/Mistral-7B-Instruct-v0.2";case"ollama":return"llama2";case"deepseek":return"deepseek-chat";default:return"gpt-3.5-turbo"}}const Z=new X({html:!1,xhtmlOut:!1,breaks:!0,linkify:!0,typographer:!0,highlight:function(t,a){return`<pre class="language-${a}"><code>${t}</code></pre>`}});function U(t){return t?Z.render(t):""}const ee={class:"ai-chat-window__header"},te={class:"ai-chat-window__title"},oe={class:"ai-chat-window__message ai-chat-window__message--user"},ae={key:0,class:"ai-chat-window__avatar ai-chat-window__avatar--user"},se=["src"],ne={key:1,class:"ai-chat-window__avatar-placeholder"},re={class:"ai-chat-window__message-content"},ie={class:"ai-chat-window__message-text"},le={key:0,class:"ai-chat-window__message-timestamp"},de={class:"ai-chat-window__message ai-chat-window__message--assistant"},ce={key:0,class:"ai-chat-window__avatar ai-chat-window__avatar--assistant"},me=["src"],he={key:1,class:"ai-chat-window__avatar-placeholder"},pe={class:"ai-chat-window__message-content"},ge=["innerHTML"],ue={key:0,class:"ai-chat-window__message-timestamp"},fe=["onClick"],we={class:"ai-chat-window__message"},ye={class:"ai-chat-window__message-role"},_e={class:"ai-chat-window__message-content"},ke={class:"ai-chat-window__message-text"},Ce={key:0,class:"ai-chat-window__loading"},Ee={class:"ai-chat-window__loading-text"},Se={key:1,class:"ai-chat-window__error"},Me={class:"ai-chat-window__error-text"},Be={class:"ai-chat-window__input-container"},Ve={class:"ai-chat-window__input-wrapper"},Ne=["placeholder","disabled","onKeydown"],be=["disabled"],Te={class:"ai-chat-window__footer"},I=e.defineComponent({__name:"AiChatWindow",props:{client:{type:Object,default:null},provider:{type:String,default:null},apiKey:{type:String,default:null},model:{type:String,default:null},baseUrl:{type:String,default:null},organizationId:{type:String,default:null},useProxy:{type:Boolean,default:!1},proxyUrl:{type:String,default:"/api/chat"},demoMode:{type:Boolean,default:!1},demoResponses:{type:Object,default:()=>({hello:"Hello! I'm a demo AI assistant. How can I help you today?",help:"I can help you with various tasks. Just ask me a question!",features:"This chatbot component supports markdown, code highlighting, streaming responses, and more!"})},title:{type:String,default:"Chat"},placeholder:{type:String,default:"Type a message..."},initialMessages:{type:Array,default:()=>[]},systemPrompt:{type:String,default:"You are a helpful assistant."},streaming:{type:Boolean,default:!0},loadingText:{type:String,default:"Thinking..."},errorText:{type:String,default:"An error occurred. Please try again."},showTimestamps:{type:Boolean,default:!1},showCopyButton:{type:Boolean,default:!0},showAvatars:{type:Boolean,default:!0},userAvatar:{type:String,default:null},assistantAvatar:{type:String,default:null},theme:{type:String,default:"light",validator:t=>["light","dark"].includes(t)},height:{type:String,default:"500px"},width:{type:String,default:"100%"},maxWidth:{type:String,default:"800px"},persistenceKey:{type:String,default:null}},emits:["message-sent","response-received","error"],setup(t,{emit:a}){const r=t,u=a,p=e.ref(""),g=e.ref(null),w=e.ref(null);!r.client&&!r.provider&&console.error("Either client or provider must be specified in AiChatWindow props");const d=e.computed(()=>({client:r.client,provider:r.provider,apiKey:r.apiKey,model:r.model,baseUrl:r.baseUrl,organizationId:r.organizationId,useProxy:r.useProxy,proxyUrl:r.proxyUrl,systemPrompt:r.systemPrompt,initialMessages:r.initialMessages,streaming:r.streaming,persistenceKey:r.persistenceKey,demoMode:r.demoMode,demoResponses:r.demoResponses,onError:o=>{u("error",{error:o})},onMessageSent:o=>{u("message-sent",{message:o})},onResponseReceived:o=>{u("response-received",{message:o})}})),{messages:b,isLoading:M,error:T,sendMessage:V,clearMessages:A}=K(d.value),f=async()=>{if(!p.value.trim()||M.value)return;const o=p.value;p.value="";try{await V(o)}catch{}},i=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),f())},y=o=>U(o),_=o=>o?new Date(o).toLocaleTimeString():"",$=o=>{navigator.clipboard.writeText(o).then(()=>{console.log("Copied to clipboard")}).catch(E=>{console.error("Failed to copy text: ",E)})};return e.watch(b,()=>{e.nextTick(()=>{g.value&&(g.value.scrollTop=g.value.scrollHeight)})},{deep:!0}),e.onMounted(()=>{w.value&&w.value.focus()}),(o,E)=>(e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass(["ai-chat-window",{"ai-chat-window--dark":t.theme==="dark"}])},[e.createElementVNode("div",ee,[e.renderSlot(o.$slots,"header",{},()=>[e.createElementVNode("h3",te,e.toDisplayString(t.title),1)])]),e.createElementVNode("div",{class:"ai-chat-window__messages",ref_key:"messagesContainer",ref:g},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(b),(c,v)=>(e.openBlock(),e.createElementBlock(e.Fragment,{key:c.id||v},[c.role==="user"?e.renderSlot(o.$slots,"user-message",{key:0,message:c,index:v},()=>[e.createElementVNode("div",oe,[t.showAvatars?(e.openBlock(),e.createElementBlock("div",ae,[t.userAvatar?(e.openBlock(),e.createElementBlock("img",{key:0,src:t.userAvatar,alt:"User"},null,8,se)):(e.openBlock(),e.createElementBlock("div",ne,"U"))])):e.createCommentVNode("",!0),e.createElementVNode("div",re,[e.createElementVNode("div",ie,e.toDisplayString(c.content),1),t.showTimestamps&&c.timestamp?(e.openBlock(),e.createElementBlock("div",le,e.toDisplayString(_(c.timestamp)),1)):e.createCommentVNode("",!0)])])]):c.role==="assistant"?e.renderSlot(o.$slots,"assistant-message",{key:1,message:c,index:v},()=>[e.createElementVNode("div",de,[t.showAvatars?(e.openBlock(),e.createElementBlock("div",ce,[t.assistantAvatar?(e.openBlock(),e.createElementBlock("img",{key:0,src:t.assistantAvatar,alt:"Assistant"},null,8,me)):(e.openBlock(),e.createElementBlock("div",he,"A"))])):e.createCommentVNode("",!0),e.createElementVNode("div",pe,[e.createElementVNode("div",{class:"ai-chat-window__message-text",innerHTML:y(c.content)},null,8,ge),t.showTimestamps&&c.timestamp?(e.openBlock(),e.createElementBlock("div",ue,e.toDisplayString(_(c.timestamp)),1)):e.createCommentVNode("",!0),t.showCopyButton?(e.openBlock(),e.createElementBlock("button",{key:1,class:"ai-chat-window__copy-button",onClick:ze=>$(c.content)}," Copy ",8,fe)):e.createCommentVNode("",!0)])])]):e.renderSlot(o.$slots,"message",{key:2,message:c,index:v},()=>[e.createElementVNode("div",we,[e.createElementVNode("div",ye,e.toDisplayString(c.role),1),e.createElementVNode("div",_e,[e.createElementVNode("div",ke,e.toDisplayString(c.content),1)])])])],64))),128)),e.unref(M)?(e.openBlock(),e.createElementBlock("div",Ce,[e.renderSlot(o.$slots,"loading",{},()=>[e.createElementVNode("div",Ee,e.toDisplayString(t.loadingText),1)])])):e.createCommentVNode("",!0),e.unref(T)?(e.openBlock(),e.createElementBlock("div",Se,[e.renderSlot(o.$slots,"error",{error:e.unref(T)},()=>[e.createElementVNode("div",Me,e.toDisplayString(t.errorText),1)])])):e.createCommentVNode("",!0)],512),e.createElementVNode("div",Be,[e.renderSlot(o.$slots,"input",{input:p.value,sendMessage:f},()=>[e.createElementVNode("div",Ve,[e.withDirectives(e.createElementVNode("textarea",{"onUpdate:modelValue":E[0]||(E[0]=c=>p.value=c),class:"ai-chat-window__input",placeholder:t.placeholder,disabled:e.unref(M),onKeydown:e.withKeys(e.withModifiers(i,["prevent"]),["enter"]),ref_key:"inputElement",ref:w},null,40,Ne),[[e.vModelText,p.value]]),e.createElementVNode("button",{class:"ai-chat-window__send-button",onClick:f,disabled:e.unref(M)||!p.value.trim()}," Send ",8,be)])])]),e.createElementVNode("div",Te,[e.renderSlot(o.$slots,"footer",{},()=>[e.unref(b).length>0?(e.openBlock(),e.createElementBlock("button",{key:0,class:"ai-chat-window__clear-button",onClick:E[1]||(E[1]=(...c)=>e.unref(A)&&e.unref(A)(...c))}," Clear Chat ")):e.createCommentVNode("",!0)])])],2))}}),Ae=e.defineComponent({name:"AiChatToggle",components:{AiChatWindow:I},props:{position:{type:String,default:"bottom",validator:t=>["bottom","top"].includes(t)},defaultOpen:{type:Boolean,default:!1},title:{type:String,default:"Chat with AI"},client:{type:Object,default:null},provider:{type:String,default:null},apiKey:{type:String,default:null},model:{type:String,default:null},placeholder:{type:String,default:"Type a message..."},initialMessages:{type:Array,default:()=>[]},systemPrompt:{type:String,default:"You are a helpful assistant."},streaming:{type:Boolean,default:!0},theme:{type:String,default:"light"},showAvatars:{type:Boolean,default:!0},persistenceKey:{type:String,default:null},demoMode:{type:Boolean,default:!1},demoResponses:{type:Object,default:()=>({hello:"Hello! I'm a demo AI assistant. How can I help you today?",help:"I can help you with various tasks. Just ask me a question!",features:"This chatbot component supports markdown, code highlighting, streaming responses, and more!"})}},emits:["toggle","message-sent","response-received","error"],setup(t,{emit:a,slots:r}){const u=e.ref(t.defaultOpen),p=e.computed(()=>!r.default),g=e.computed(()=>{const d={placeholder:t.placeholder,initialMessages:t.initialMessages,systemPrompt:t.systemPrompt,streaming:t.streaming,theme:t.theme,showAvatars:t.showAvatars,persistenceKey:t.persistenceKey,demoMode:t.demoMode,demoResponses:t.demoResponses};return t.client?d.client=t.client:t.provider&&(d.provider=t.provider,t.apiKey&&(d.apiKey=t.apiKey),t.model&&(d.model=t.model)),d}),w=()=>{u.value=!u.value,a("toggle",u.value)};return e.watch(()=>t.defaultOpen,d=>{u.value=d}),{isOpen:u,toggleChat:w,useDefaultChat:p,chatProps:g}}}),$e=(t,a)=>{const r=t.__vccOpts||t;for(const[u,p]of a)r[u]=p;return r},ve=["aria-label","title"],Ie={key:0,class:"ai-chat-toggle__icon ai-chat-toggle__icon--open"},Oe={key:1,class:"ai-chat-toggle__icon ai-chat-toggle__icon--close"},Pe={class:"ai-chat-toggle__window"},De={key:0,class:"ai-chat-toggle__header"},Ke={class:"ai-chat-toggle__title"},Re={class:"ai-chat-toggle__content"};function Ue(t,a,r,u,p,g){const w=e.resolveComponent("AiChatWindow");return e.openBlock(),e.createElementBlock("div",{class:e.normalizeClass(["ai-chat-toggle",{"ai-chat-toggle--open":t.isOpen,"ai-chat-toggle--bottom":t.position==="bottom","ai-chat-toggle--top":t.position==="top"}])},[e.createElementVNode("button",{class:"ai-chat-toggle__button",onClick:a[0]||(a[0]=(...d)=>t.toggleChat&&t.toggleChat(...d)),"aria-label":t.isOpen?"Close chat":"Open chat",title:t.isOpen?"Close chat":"Open chat"},[t.isOpen?(e.openBlock(),e.createElementBlock("span",Oe,[e.renderSlot(t.$slots,"close-icon",{},()=>[a[6]||(a[6]=e.createElementVNode("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e.createElementVNode("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.createElementVNode("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1))])])):(e.openBlock(),e.createElementBlock("span",Ie,[e.renderSlot(t.$slots,"toggle-icon",{},()=>[a[5]||(a[5]=e.createElementVNode("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e.createElementVNode("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})],-1))])]))],8,ve),e.withDirectives(e.createElementVNode("div",Pe,[t.title?(e.openBlock(),e.createElementBlock("div",De,[e.createElementVNode("h3",Ke,e.toDisplayString(t.title),1),e.createElementVNode("button",{class:"ai-chat-toggle__close",onClick:a[1]||(a[1]=(...d)=>t.toggleChat&&t.toggleChat(...d)),"aria-label":"Close chat"},a[7]||(a[7]=[e.createElementVNode("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[e.createElementVNode("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.createElementVNode("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)]))])):e.createCommentVNode("",!0),e.createElementVNode("div",Re,[t.useDefaultChat?(e.openBlock(),e.createBlock(w,e.mergeProps({key:0},t.chatProps,{onMessageSent:a[2]||(a[2]=d=>t.$emit("message-sent",d)),onResponseReceived:a[3]||(a[3]=d=>t.$emit("response-received",d)),onError:a[4]||(a[4]=d=>t.$emit("error",d))}),null,16)):e.renderSlot(t.$slots,"default",{key:1})])],512),[[e.vShow,t.isOpen]])],2)}const x=$e(Ae,[["render",Ue]]),{createCompatComponent:j,registerCompatComponent:z,createCompatPlugin:xe}=require("@aivue/core"),q=j(I),L=j(x),W=K,H={formatMarkdown:U},J=xe({install(t){z(t,"AiChatWindow",I),z(t,"AiChatToggle",x)}}),je={AiChatWindow:q,AiChatToggle:L,useChatEngine:W,utils:H,AiChatPlugin:J};h.AiChatPlugin=J,h.AiChatToggle=L,h.AiChatWindow=q,h.default=je,h.useChatEngine=W,h.utils=H,Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.js.map
